<div class="filter-form">
  <h3>Filters</h3>

  <%= form_with url: streams_path, method: :get do |f| %>
    <div class="filter-group">
      <label>Search</label>
      <%= f.text_field "filters[query]", value: @current_filters[:query],
          placeholder: "Search messages...",
          class: "form-input" %>
    </div>

    <% if @available_filters[:levels]&.any? %>
      <div class="filter-group">
        <label>Log Level</label>
        <% @available_filters[:levels].each do |level| %>
          <div class="checkbox-item">
            <%= checkbox_tag "filters[levels][]", level,
                @current_filters[:levels].include?(level),
                id: "level_#{level}" %>
            <%= f.label "level_#{level}" do %>
              <%= level_badge(level) %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:apps]&.any? %>
      <div class="filter-group">
        <label>Application</label>
        <% if @available_filters[:apps].size <= 5 %>
          <% @available_filters[:apps].each do |app_name| %>
            <div class="checkbox-item">
              <%= checkbox_tag "filters[app][]", app_name,
                  @current_filters[:app].include?(app_name),
                  id: "app_#{app_name.parameterize}" %>
              <%= f.label "app_#{app_name.parameterize}", app_name %>
            </div>
          <% end %>
        <% else %>
          <%= render "solid_log/shared/checkbox_dropdown",
              field_name: "filters[app]",
              options: @available_filters[:apps],
              selected: @current_filters[:app],
              label: "Select Applications",
              id_prefix: "app" %>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:envs]&.any? %>
      <div class="filter-group">
        <label>Environment</label>
        <% @available_filters[:envs].each do |env_name| %>
          <div class="checkbox-item">
            <%= checkbox_tag "filters[env][]", env_name,
                @current_filters[:env].include?(env_name),
                id: "env_#{env_name.parameterize}" %>
            <%= f.label "env_#{env_name.parameterize}", env_name %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:controllers]&.any? %>
      <div class="filter-group">
        <label>Controller</label>
        <% if @available_filters[:controllers].size <= 1 %>
          <% @available_filters[:controllers].each do |controller_name| %>
            <div class="checkbox-item">
              <%= checkbox_tag "filters[controller][]", controller_name,
                  @current_filters[:controller].include?(controller_name),
                  id: "controller_#{controller_name.parameterize}" %>
              <%= f.label "controller_#{controller_name.parameterize}", controller_name %>
            </div>
          <% end %>
        <% else %>
          <%= render "solid_log/shared/checkbox_dropdown",
              field_name: "filters[controller]",
              options: @available_filters[:controllers],
              selected: @current_filters[:controller],
              label: "Select Controllers",
              id_prefix: "controller" %>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:actions]&.any? %>
      <div class="filter-group">
        <label>Action</label>
        <% if @available_filters[:actions].size <= 5 %>
          <% @available_filters[:actions].each do |action_name| %>
            <div class="checkbox-item">
              <%= checkbox_tag "filters[action][]", action_name,
                  @current_filters[:action].include?(action_name),
                  id: "action_#{action_name.parameterize}" %>
              <%= f.label "action_#{action_name.parameterize}", action_name %>
            </div>
          <% end %>
        <% else %>
          <%= render "solid_log/shared/checkbox_dropdown",
              field_name: "filters[action]",
              options: @available_filters[:actions],
              selected: @current_filters[:action],
              label: "Select Actions",
              id_prefix: "action" %>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:methods]&.any? %>
      <div class="filter-group">
        <label>HTTP Method</label>
        <% @available_filters[:methods].each do |method_name| %>
          <div class="checkbox-item">
            <%= checkbox_tag "filters[method][]", method_name,
                @current_filters[:method].include?(method_name),
                id: "method_#{method_name.parameterize}" %>
            <%= f.label "method_#{method_name.parameterize}", method_name %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:paths]&.any? %>
      <div class="filter-group">
        <label>Path</label>
        <% if @available_filters[:paths].size <= 5 %>
          <% @available_filters[:paths].each do |path_name| %>
            <div class="checkbox-item">
              <%= checkbox_tag "filters[path][]", path_name,
                  @current_filters[:path].include?(path_name),
                  id: "path_#{path_name.parameterize}" %>
              <%= f.label "path_#{path_name.parameterize}", path_name %>
            </div>
          <% end %>
        <% else %>
          <%= render "solid_log/shared/checkbox_dropdown",
              field_name: "filters[path]",
              options: @available_filters[:paths],
              selected: @current_filters[:path],
              label: "Select Paths",
              id_prefix: "path" %>
        <% end %>
      </div>
    <% end %>

    <% if @available_filters[:status_codes]&.any? %>
      <div class="filter-group">
        <label>Status Code</label>
        <% @available_filters[:status_codes].each do |code| %>
          <div class="checkbox-item">
            <%= checkbox_tag "filters[status_code][]", code,
                @current_filters[:status_code].include?(code.to_s),
                id: "status_code_#{code}" %>
            <%= f.label "status_code_#{code}" do %>
              <%= http_status_badge(code) %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="filter-group">
      <label>Duration (ms)</label>
      <div class="time-inputs">
        <%= f.number_field "filters[min_duration]", value: @current_filters[:min_duration],
            placeholder: "Min",
            class: "form-input form-input-small" %>
        <%= f.number_field "filters[max_duration]", value: @current_filters[:max_duration],
            placeholder: "Max",
            class: "form-input form-input-small" %>
      </div>
    </div>

    <div class="filter-group">
      <label>Time Range</label>
      <div class="time-inputs">
        <%= f.datetime_field "filters[start_time]", value: @current_filters[:start_time],
            placeholder: "Start time",
            class: "form-input form-input-small" %>
        <%= f.datetime_field "filters[end_time]", value: @current_filters[:end_time],
            placeholder: "End time",
            class: "form-input form-input-small" %>
      </div>
    </div>

    <div class="filter-group">
      <label>Request ID</label>
      <%= f.text_field "filters[request_id]", value: @current_filters[:request_id],
          placeholder: "Filter by request...",
          class: "form-input" %>
    </div>

    <div class="filter-group">
      <label>Job ID</label>
      <%= f.text_field "filters[job_id]", value: @current_filters[:job_id],
          placeholder: "Filter by job...",
          class: "form-input" %>
    </div>

    <%# Dynamically render promoted field filters with facets %>
    <% @available_filters.each do |key, values| %>
      <% next if [:levels, :apps, :envs, :controllers, :actions, :methods, :paths, :status_codes].include?(key) %>
      <% next unless values&.any? %>

      <% field = SolidLog::Field.promoted.find_by(name: key.to_s) %>
      <% next unless field %>

      <div class="filter-group">
        <label><%= key.to_s.titleize %></label>

        <% case field.filter_type %>
        <% when "multiselect" %>
          <% if values.size <= 5 %>
            <% values.each do |value| %>
              <div class="checkbox-item">
                <%= checkbox_tag "filters[#{key}][]", value,
                    Array(@current_filters[key]).include?(value),
                    id: "#{key}_#{value.to_s.parameterize}" %>
                <%= f.label "#{key}_#{value.to_s.parameterize}", value %>
              </div>
            <% end %>
          <% else %>
            <%= render "solid_log/shared/checkbox_dropdown",
                field_name: "filters[#{key}]",
                options: values,
                selected: Array(@current_filters[key]),
                label: "Select #{key.to_s.titleize}",
                id_prefix: key.to_s %>
          <% end %>

        <% when "range" %>
          <div class="time-inputs">
            <%= f.number_field "filters[min_#{key}]", value: @current_filters["min_#{key}".to_sym],
                placeholder: "Min",
                class: "form-input form-input-small" %>
            <%= f.number_field "filters[max_#{key}]", value: @current_filters["max_#{key}".to_sym],
                placeholder: "Max",
                class: "form-input form-input-small" %>
          </div>

        <% when "contains" %>
          <%= f.text_field "filters[#{key}]", value: @current_filters[key],
              placeholder: "Search #{key.to_s.titleize}...",
              class: "form-input" %>

        <% when "exact" %>
          <%= f.select "filters[#{key}]",
              options_for_select([["All #{key.to_s.titleize}", ""]] + values.map { |v| [v, v] }, @current_filters[key]),
              class: "form-select" %>
        <% end %>
      </div>
    <% end %>

    <%# Render token-based promoted fields (no facets needed) %>
    <% SolidLog::Field.promoted.where(filter_type: "tokens").each do |field| %>
      <% next unless SolidLog::Entry.column_names.include?(field.name) %>
      <div class="filter-group">
        <label><%= field.name.titleize %></label>
        <%= f.text_field "filters[#{field.name}]", value: @current_filters[field.name.to_sym],
            placeholder: "Enter #{field.name.titleize} (comma-separated)...",
            class: "form-input" %>
        <small class="form-hint">Enter multiple values separated by commas</small>
      </div>
    <% end %>

    <div class="filter-actions">
      <%= f.submit "Apply Filters", class: "btn btn-primary btn-block" %>
      <%= link_to "Clear", streams_path, class: "btn btn-secondary btn-block" %>
    </div>
  <% end %>
</div>
