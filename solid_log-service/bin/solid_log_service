#!/usr/bin/env ruby

require 'bundler/setup'
require 'rack'
require_relative '../lib/solid_log/service'

# Parse command line options
options = {
  port: ENV['PORT'] || SolidLog::Service.configuration.port || 3001,
  bind: ENV['BIND'] || SolidLog::Service.configuration.bind || '0.0.0.0',
  environment: ENV['RAILS_ENV'] || ENV['RACK_ENV'] || 'production'
}

ARGV.each do |arg|
  case arg
  when /^--port=(\d+)$/
    options[:port] = $1.to_i
  when /^--bind=(.+)$/
    options[:bind] = $1
  when /^--environment=(.+)$/
    options[:environment] = $1
  when '--help', '-h'
    puts <<~HELP
      SolidLog Service - Standalone log ingestion and processing service

      Usage: solid_log_service [options]

      Options:
        --port=PORT              Port to bind to (default: 3001)
        --bind=ADDRESS           Address to bind to (default: 0.0.0.0)
        --environment=ENV        Environment (default: production)
        --help, -h               Show this help message

      Environment Variables:
        PORT                     Port to bind to
        BIND                     Address to bind to
        RAILS_ENV                Rails environment
        DATABASE_URL             Database connection string
        LOG_LEVEL                Log level (debug, info, warn, error)

      Examples:
        solid_log_service
        solid_log_service --port=8080 --bind=127.0.0.1
        PORT=8080 solid_log_service

      Configuration:
        Create config/solid_log_service.rb to configure the service.
        See README.md for configuration options.
    HELP
    exit 0
  end
end

# Set environment
ENV['RAILS_ENV'] = options[:environment]
ENV['RACK_ENV'] = options[:environment]

puts "Starting SolidLog Service..."
puts "  Environment: #{options[:environment]}"
puts "  Binding: #{options[:bind]}:#{options[:port]}"

# Load the application
require_relative '../config.ru'

# Run with Puma
require 'puma/cli'

puma_args = [
  '--bind', "tcp://#{options[:bind]}:#{options[:port]}",
  '--environment', options[:environment],
  '--workers', ENV.fetch('WEB_CONCURRENCY', '2'),
  '--threads', "#{ENV.fetch('RAILS_MIN_THREADS', '5')}:#{ENV.fetch('RAILS_MAX_THREADS', '5')}"
]

Puma::CLI.new(puma_args).run
