# Example: Kamal Deployment with SolidLog Service as Accessory
# Place this in: config/deploy.yml

service: myapp
image: myapp/myapp

servers:
  web:
    hosts:
      - 192.168.1.1

# Shared volume for both main app and SolidLog
volumes:
  - solidlog-data:/rails/storage  # Main app writes here

# SolidLog Service as Kamal accessory
accessories:
  solidlog:
    image: ghcr.io/namolnad/solid_log/solid_log-service:latest-sqlite
    host: 192.168.1.1
    cmd: bundle exec solid_log_service
    env:
      clear:
        SOLIDLOG_DATABASE_URL: "sqlite3:///app/storage/production_log.sqlite"
        SOLIDLOG_PORT: "3001"
        SOLIDLOG_BIND: "0.0.0.0"
        SOLIDLOG_PARSER_INTERVAL: "10"
        SOLIDLOG_CACHE_CLEANUP_INTERVAL: "3600"
        SOLIDLOG_RETENTION_DAYS: "30"
        SOLIDLOG_ERROR_RETENTION_DAYS: "90"
      secret:
        - SOLIDLOG_TOKEN
    volumes:
      - solidlog-data:/app/storage  # Same volume, service reads/writes here
    options:
      network: "private"

registry:
  server: ghcr.io
  username: namolnad
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    RAILS_ENV: production
  secret:
    - RAILS_MASTER_KEY
    - SOLIDLOG_TOKEN

# Main app configuration
# config/initializers/solid_log_client.rb:
#
# SolidLog::Core.configure_client do |config|
#   config.service_url = 'http://myapp-solidlog:3001'  # Internal Docker network
#   config.token = ENV['SOLIDLOG_TOKEN']
#   config.app_name = 'myapp'
#   config.environment = Rails.env
# end
#
# SolidLog::Core::Client.start

# Service configuration
# config/solid_log_service.rb:
#
# SolidLog::Service.configure do |config|
#   config.job_mode = :scheduler
#   config.parser_interval = 10
#   config.retention_days = 30
# end

# Deploy:
#   kamal deploy
#
# Deploy only service:
#   kamal deploy --roles=solidlog
